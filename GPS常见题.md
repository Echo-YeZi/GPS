## 1.Android GPS大概框架 描述

### 1.1 Qcom平台GPS框架

![image-20200615023854454](C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20200615023854454.png)

1. GPS Application和LocationManagerService所在进程通过Binder机制进行跨进程调用。

2. GpsLocationProvider和com_android_server_location_GpsLocationProvide以及com_android_server_location_GpsLocationProvide和gps.so库相互之间都是通过数据结构进行回调。

   > com_android_server_location_GpsLocationProvide只是Framework和HAL之间的一个桥梁

3. HAL的gps.so库和Modem通过高通的QMI机制进行数据传输,并且数据的格式是NMEA类型。

### **1.2 GPS模块的代码结构**

![img](https://img-blog.csdn.net/20140113223636656?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZmFudGFzeWh1amlhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

#### 1.2.1 Framework

1. frameworks/base/location/java/android/location

   > 这里主要是用来被App调用的，API包是android.location。 

2. frameworks/base/location/java/com/android/internal/location

   > 这个目录是Framework对Location服务的内部实现。

3. framework\services\java\com\android\server

   > 这个目录只有一个文件
   > |-- LocationManagerService.java
   > 是Location服务对内部实现的一种封装。

#### 1.2.2 JNI

> frameworks/base/core/jni/android_location_GpsLocationProvider.cpp

> JNI层只有一个文件，起到承上启下的作用。上层承接Framework，下层调用HAL层具体硬件抽象实现。

#### 1.2.3 HAL

> Hardware Abstract Layer 硬件抽象层
>
> - hardware\libhardware_legacy\gps
> - hardware\libhardware_legacy\include\hardware_legacy\gps.h

> HAL层相当于一个linux应用程序接口，通过open，close等操作，操作硬件设备。

> Android的源代码只实现了模拟器的gps接口，具体在文件gps_qemu.c中。在2.3版本中提供了对QCOM公司的gps的实现，在以下目录：\hardware\qcom

#### 1.2.4 数据结构

1. GpsInterface

   > 底层驱动实现的接口
   >
   > 如果要porting到自己的板子上，就需要实现这些接口。
   >
   > 该接口的定义在gps.h中，模拟器实现在gps_qemu.c中

2. GpsCallbacks回调函数

   > 回调函数结构体
   >
   > 定义也在gps.h中,实现是在android_location_GpsLocationProvider.cpp中
   >
   > google已经实现了，无需修改

3. GpsLocation

   > Locatin数据信息
   >
   > 底层驱动获得Location的raw信息，通常是nmea码，然后通过解析就得到了location信息



## 2.Android 平台有哪些定位方式

1. GPS定位

2. 网络定位



## 3. GPS 冷启动，温启动，热启动区别

**GPS开机定位分为冷启动、温启动和热启动三种**

- 冷启动：以下几种情况开机均属冷启动。

  > 初次使用时；电池耗尽导致星历信息丢失时；
  >
  > 关机状态下将接收机移动200公里以上距离。

- 温启动：距离上次定位的时间超过两个小时的启动。

- 热启动：距离上次定位的时间小于两个小时的启动。



## 4.高通 GPS 辅助定位机制

1. AGPS（Assisted GPS，A-GPS，网络辅助GPS）

   > https://www.cnblogs.com/magicboy110/archive/2010/12/12/1903927.html
   >
   > 结合了GPS定位和蜂窝基站定位的优势，借助蜂窝网络的数据传输功能，达到很高的定位精度和很快的定位速度
   >
   > > **定位基本机制**
   > >
   > > 包括GPS的定位和基于蜂窝基站的定位两类
   > >
   > > ![AGPS_thumb30](https://images.cnblogs.com/cnblogs_com/magicboy110/201012/201012122102351542.png)
   > >
   > > > **GPS定位的弱点**
   > > >
   > > > 1. 硬件初始化（首次搜索卫星）时间较长，需要几分钟至十几分钟
   > > > 2. GPS卫星信号穿透力弱，容易受到建筑物、树木等的阻挡而影响定位精度
   > > >
   > > > **AGPS通过网络辅助进行解决**
   > > >
   > > > 1. 通过从蜂窝网络下载当前地区的可用卫星信息（包含当地区可用的卫星频段、方位、仰角等信息），从而避免了全频段大范围搜索，使首次搜星速度大大提高，时间由原来的几分钟减小到几秒钟
   > > > 2. 通过蜂窝基站参考GPS的辅助，或是借助GSM定位中Cell-ID定位（COO定位）方法的辅助，缓解了在GPS信号不良的情况下定位的问题，有效提高了在此情况下的定位精度,但无法彻底解决穿透力问题
   >
   > >定位基本流程
   > >
   > >![AGPS1_thumb11](https://images.cnblogs.com/cnblogs_com/magicboy110/201012/201012122102425832.png)\
   > >
   > >1. 搜索卫星
   > >
   > >   > 通过网络直接下载当前地区的可用卫星信息,提升了搜索速度也降低了设备能耗
   > >   >
   > >   > 1. 设备从蜂窝基站获取到当前所在的小区位置（即一次COO定位）
   > >   > 2. 设备通过蜂窝网络将当前蜂窝小区位置传送给网络中的AGPS位置服务器
   > >   > 3. APGS位置服务器根据当前小区位置查询该区域当前可用的卫星信息（包括卫星的频段、方位、仰角等相关信息），并返回给设备
   > >   > 4. GPS接收器根据得到的可用卫星信息，可以快速找到当前可用的GPS卫星
   > >   >
   > >   > 至此，GPS接收器已经可正常接收GPS信号，GPS初始化过程结束
   > >
   > >2. 计算位置
   > >
   > >   > 两种方案
   > >   >
   > >   > 1. MS-Based方式
   > >   >
   > >   >    > 过程与传统GPS定位完全相同，GPS接收器接收原始GPS信号，解调并进行一定处理，根据处理后的信息进行位置计算，得到最终的位置坐标
   > >   >
   > >   > 2. MS-Assisted方式
   > >   >
   > >   >    > 解调并处理后,追加操作
   > >   >    >
   > >   >    > 5. 设备将处理后的GPS信息（伪距信息）通过蜂窝网络传输给AGPS位置服务器
   > >   >    > 6. AGPS服务器根据伪距信息，并结合其他途径（蜂窝基站定位、参考GPS定位等）得到的辅助定位信息，计算出最终的位置坐标，返回给设备
   > >   >    >
   > >   >    > **优势**
   > >   >    >
   > >   >    > - 由于辅助定位信息的加入，可以取得更高的定位精度；
   > >   >    > - 可以很大程度上克服弱GPS信号情况下的无法定位或精度降低的问题；
   > >   >    > - 将复杂计算转移到网络端，也可以很大程度上减小设备的电量消耗
   >
   > > 优劣分析
   > >
   > > > 与传统GPS定位相比,优势
   > > >
   > > > 1. 首次搜星速度快
   > > > 2. 有效减少设备的电量消耗
   > > >
   > > > 采用MS-Assisted方式优势
   > > >
   > > > 1. 定位精度更高
   > > > 2. 缓解弱GPS信号情况下无法定位或精度降低的问题
   > > > 3. 对移动设备的计算能力要求更低
   > > >
   > > > 限制
   > > >
   > > > 1. 必须有蜂窝网络（GRRS/EDGE/CDMA等）的支持用以数据传输，对一般用户而言可能需要为此支付一定的数据流量费用
   > > > 2. 必须有AGPS位置服务器的支持
   > > > 3. 与GPS一样，仍无法完美解决室内（室内无法接收GPS信号）定位的问题
   >
   > > 实际应用
   > >
   > > > 因为AGPS需要网络支持，因此目前使用该技术的大部分设备为手机
   > >
   > > 1. 目前大部分支持AGPS的手机采用一种纯软件的AGPS方案
   > >
   > >    >基于MS-Based
   > >    >
   > >    >定期下载星历数据到手机中，手机中的AGPS软件会根据星历信息计算出当前位置的可用卫星信息，从而提供给设备用于快速搜星。用户可以选择通过WiFi、固网等免费网络定期更新星历数据，从而避免使用蜂窝网络产生的数据流量费用。当然，由于星历信息可能存在延迟，因此搜星时速度可能有所下降，但是仍然会比传统GPS定位快很多倍。
   > >    >
   > >    >该方案的优点是纯软件，不需要专门的AGPS硬件，几乎所有GPS手机都可以使用；同时用户可以根据情况指定星历更新周期及更新方式，控制或减免蜂窝网络数据流量。
   > >    >
   > >    >HTC的大部分AGPS手机都采用这种方案
   > >
   > > 2. 部分运营商的AGPS方案中，实施了在无GPS信号时自动切换到GSM蜂窝基站Cell-ID定位的措施，从而一定程度上解决了室内定位的问题
   > >
   > >    >如中国移动的OMA AGPS方案
   > >
   > > 3. 世界范围内一些AGPS芯片或相关服务已经广泛使用
   > >
   > >    > SiRF公司的[AGPS芯片](http://gps.about.com/od/glossary/g/A-GPS.htm)提供了硬件层次上的AGPS方案
   > >    >
   > >    > [U-Blox](http://www.u-blox.com/zh/assisted-gps.html)的[AssistNow A-GPS服务](http://www.eefocus.com/article/08-05/42111s.html)提供了AssistNow Online(在线AssistNow)和AssistNow OffLine(离线AssistNow)两种易用的AGPS方案。实际上这两种方案分别就是MS-Assisted和MS-Based两种定位计算方式的实现。
   > >
   > > 4. 国内电信运营商的AGPS方案
   > >
   > >    > 中国移动正在制订的A-GPS方案基于OMA的SUPL规范，是一种用户平面的解决方案。
   > >    >
   > >    > 中国联通提供的gpsOne是MS-Assisted方式的A-GPS定位方案，也基于用户平面方式，目前只用于CDMA网络

2. XTRA

   > 类似AGPS的技术，高通独有。MTK也有类似的技术EPO



## 5 .网络定位实现原理是什么样？

1. WIFI定位：

   > http://www.360doc.com/content/18/0410/10/542605_744382751.shtml
   >
   > > 原理
   > >
   > > 1. 每一个无线AP都有一个全球唯一的MAC地址,并且一般来说无线AP在一段时间内是不会移动的。
   > > 2. 设备在开启Wi-Fi的情况下,即可扫描并收集周围的AP信号,无论是否加密,是否已连接，甚至信号强度不足以显示在无线信号列表中,都可以获取到AP广播出来的MAC地址。
   > > 3. 设备将这些能够标示AP的数据发送到位置服务器,服务器检索出每一个AP的地理位置,并结合每个信号的强弱程度,计算出设备的地理位置并返回到用户设备。
   > > 4. 位置服务商要不断更新、补充自己的数据库,以保证数据的准确性,毕竟无线AP不像基站塔那样基本100%不会移动。
   >
   > > 服务商在美国有Skyhook和Google两家
   >
   > > 收集位置数据的方式
   > >
   > > 1. 主动采集
   > >
   > >    > 街景拍摄车或者信号采集车,采集沿途的无线信号、AP和基站的信号数据,并打上通过GPS定位出的坐标回传至服务器
   > >
   > > 2. 用户提交
   > >
   > >    > Android手机用户在开启“使用无线网络定位”时会提示是否允许Google的定位服务手机匿名地点数据。
   > >    >
   > >    > Skyhook的最大客户Apple也在iPhone的User Guide中说明会以不能识别用户身份的方式收集位置数据。
   >
   > > 步骤
   > >
   > > 1. 数据采集与制备，通过主动采集和用户手机静默上传获取每个WiFi热点的位置信息
   > >
   > >    > 手机扫描附近WI-FI信号,获取其BSSID,即设备MAC地址,然后向采集方的数据库添加数据【BSSID、（X1，Y1）】，其中（X1，Y1）正是GPS 定位得到的坐标
   > >
   > >    > 一个WI-FI信号可能被采集多次,那么其坐标信息就会越来越准确
   > >    >
   > >    > 其实际数据应该是【BSSID、（X1，Y1），（X2，Y2）...（Xn，Yn）】
   > >    >
   > >    > 最终计算出的位置数据应该是【BSSID、（X，Y）】
   > >
   > > 2. 确定移动设备与热点的距离
   > >
   > >    > Wi-Fi信号是电磁波，其信号强度会随着传播距离的增加而衰减
   > >    >
   > >    > 设备连接上某WI-FI后，会自动记录能够捕获的WiFi强度-RSSI，通过模型RSSI=a+b*log（d）计算出与路由器的距离
   > >
   > > 3. 通过算法推断出移动设备的位置
   > >
   > >    > 主流有三种算法
   > >    >
   > >    > 1. 三角定位算法
   > >    >
   > >    >    > 以WiFi 的坐标为圆心画圆，圆的半径是手机与热点之间的距离，三圆重叠处就有可能是手机的位置
   > >    >    >
   > >    >    > 但因为距离并不精确，故定位的结果更加不准确，会有更大的误差
   > >    >
   > >    > 2. 指纹定位算法
   > >    >
   > >    >    > 设备扫描周围所有WiFi 的 BSSID，将采集到的BBSID序列作为WiFi指纹信息存入数据库，当该序列与已有序列匹配时，则视为同一坐标
   > >    >    >
   > >    >    > **缺点**
   > >    >    >
   > >    >    > - 采集量需要非常大
   > >    >    > - 对服务端性能和数据存储要求太高
   > >    >    > - Wi-Fi不密集的地方，定位结果会非常糟糕
   > >    >
   > >    > 3. 最大似然估算法
   > >    >
   > >    >    > 最大似然法（Maximum Likelihood，ML）也称为最大概似估计，也叫极大似然估计，是一种具有理论性的点估计法
   > >    >
   > >    >    > **基本思想**
   > >    >    >
   > >    >    > 当从模型总体随机抽取n组样本观测值后，最合理的参数估计量应该使得从模型中抽取该n组样本观测值的概率最大，而不是像最小二乘估计法旨在得到使得模型能最好地拟合样本数据的参数估计量
   > >    >
   > >    >    > 最大似然法功率谱估计是一种可获得高分辨率的非线性谱估值方法，它特别适用于水声、地震波等信号的频率波数功率谱估值；同样，也可用于平稳时间序列的功率谱估值。最大似然法功率谱估值的分辨率略低于最大熵法功率谱估值，但其性能更为稳定。
   > >    >
   > >    >    > **说直白一点就是三角算法结合概率论的算法**

2. 基站定位

   > https://blog.csdn.net/beyond181/article/details/7867907
   >
   > > **优点**
   > >
   > > 定位速度快、成本低（不需要移动终端上添加额外的硬件）、耗电少、室内可用
   >
   > > 1. COO（Cell of Origin）定位COO定位是一种单基站定位，即根据设备当前连接的蜂窝基站的位置来确定设备的位置
   > >
   > >    > COO定位其精度是不太确定的。但是这却是GSM网络中的移动设备最快捷、最方便的定位方法，因为GSM网络端以及设备端都不需要任何的额外硬件投入。
   > >
   > >    > Google地图移动版中，通过蜂窝基站确定“我的位置”，基本上用的就是这种方法
   > >
   > > 2. 七号信令定位
   > >
   > >    > 以信令监测为基础，能够对移动通信网中特定的信令过程，如漫游、切换以及与电路相关的信令过程进行过滤和分析，并将监测结果提供给业务中心，以实现对特定用户的个性化服务
   > >
   > >    > 国内各省和地区移动公司的短信欢迎系统采用的就是此种技术
   > >
   > > 3. TOA/TDOA定位
   > >
   > >    > TOA(Time of Arrival，到达时间)、TDOA(Time Difference of Arrival,到达时间差)都是基于电波传播时间的定位方法。同时也都是三基站定位方法，二者的定位都需要同时有三个位置已知的基站合作才能进行
   > >    >
   > >    > ![TOA_DTOA_thumb6](http://images.cnblogs.com/cnblogs_com/magicboy110/201012/201012102349011337.png)
   > >    >
   > >    > > TOA电波到达时间定位基本原理是得到Ti(i=1,2,3)后，由Ti*c得到设备到基站i之间的距离Ri，然后根据几何只是建立方程组并求解，从而求得Location值
   > >    > >
   > >    > > 由于距离的计算完全依赖于时间，因此TOA算法对系统的时间同步要求很高，任何很小的时间误差都会被放大很多倍，同时由于多径效应的影响又会带来很大的误差，因而单纯的TOA在实际中应用很少
   > >    > >
   > >    > > ![TOA_thumb1](http://images.cnblogs.com/cnblogs_com/magicboy110/201012/201012102349037857.png)
   > >    >
   > >    > > DTOA电波到达时间差定位是对TOA定位的改进，与TOA的不同之处在于，得到Ti后不是立即用Ti去求距离Ri，而是先对T1,T2,T3两两求差，然后通过一些巧妙的数学算法建立方程组并求解，从而得到Location值
   > >    > >
   > >    > > DTOA由于其中巧妙设计的求差过程会抵消其中很大一部分的时间误差和多径效应带来的误差，因而可以大大提高定位的精确度。
   > >    > >
   > >    > > 由于DTOA对网络要求相对较低，并且精度较高，因而目前已经成为研究的热点
   > >    > >
   > >    > > ![DTOA_thumb](http://images.cnblogs.com/cnblogs_com/magicboy110/201012/201012102349044137.png)
   > >
   > > 4. AOA定位
   > >
   > >    >AOA(Angle of Arrival，到达角度)定位是一种两基站定位方法，基于信号的入射角度进行定位
   > >
   > >    > ![AOA_thumb](http://images.cnblogs.com/cnblogs_com/magicboy110/201012/201012102349052544.png)
   > >    >
   > >    > 知道了基站1到设备之间连线与基准方向的夹角α1，就可以画出一条射线L1；同样知道了知道了基站2到设备之间连线与基准方向的夹角α2，就可以画出一条射线L2。那么L1月L2的交点就是设备的位置
   > >    >
   > >    > AOA定位通过两直线相交确定位置，不可能有多个交点，避免了定位的模糊性。但是为了测量电磁波的入射角度，接收机必须配备方向性强的天线阵列
   > >
   > > 5. 基于场强的定位
   > >
   > >    >通过测出接收到的信号场强和已知的信道衰落模型及发射信号的场强值估计收发信短的距离，根据多个三个距离值就可以得到设备的位置。从数学模型上看，和TOA算法类似，只是获取距离的方式不同。
   > >
   > >    > 场强算法虽然简单，但是由于多径效应的影响，定位精度较差。
   > >
   > > 6. 混合定位
   > >
   > >    > 同时使用两种以上的定位方法来进行定位。通过各种定位方法之间结合使用，互补短长，以达到更高的定位精度
   > >
   > >    > A-GPS定位（辅助GPS定位）就是一种混合定位，是GPS定位技术与GSM网络的结合。A-GPS具有很高的定位精度，目前正被越来越广泛的使用



## 6.GPS 常用性能测试的方法有哪些？

1. TTFF测试
2. CEP测试
3. 步行轨迹测试
4. 车行轨迹测试



## 7.遇到性能问题的处理思路是什么样的？

1. 分析日志里的定位流程是否正常;
2. 查看定位过程的测量数据是否符合标准;
3. 对基础性能测试，询问平台定位收敛算法是否有异常；
4. 对轨迹测试项，查看sensor辅助定位是否正常工作。



## 8.是否做过的GPS优化算法

NA

https://wenku.baidu.com/view/6c01fa3aba68a98271fe910ef12d2af90342a87f.html